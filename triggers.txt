-- TRIGGER 1: GERAÇÃO AUTOMÁTICA DE ALERTAS (Critérios de Risco)
-- Analisa cada nova órbita e gera alertas baseados no tamanho e proximidade.

CREATE OR ALTER TRIGGER trg_GerarAlertas_Orbita
ON Orbital_Parameters
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    -- Declaração de limiares (convertidos para KM e UA conforme os dados reais)
    DECLARE @Diametro_10m FLOAT = 0.01;
    DECLARE @Diametro_30m FLOAT = 0.03;
    DECLARE @Diametro_100m FLOAT = 0.1;
    DECLARE @Diametro_500m FLOAT = 0.5;
    DECLARE @Distancia_1LD_UA FLOAT = 0.00257;

    INSERT INTO Alert (asteroid_id, alert_date, priority_level, description, is_active)
    SELECT
        i.asteroid_id,
        GETDATE(),
        CASE
            -- Nível 4 (Vermelho): Diâmetro > 30m E aproximação < 1 Distância Lunar
            WHEN a.diameter > @Diametro_30m AND i.moid < @Distancia_1LD_UA THEN 4

            -- Nível 3 (Laranja): Diâmetro > 50m E moid_ld < 5 E dados precisos (rms < 0.3)
            WHEN a.diameter > 0.05 AND i.moid_ld < 5 AND i.rms < 0.3 THEN 3

            -- Alta Prioridade: PHA confirmado, > 100m, incerteza alta (rms > 0.8), moid < 20 LD
            WHEN a.pha = 'Y' AND a.diameter > @Diametro_100m AND i.rms > 0.8 AND i.moid_ld < 20 THEN 3

            -- Média Prioridade: Grande porte (>500m) e passa a < 50 LD
            WHEN a.diameter > @Diametro_500m AND i.moid_ld < 50 THEN 2

            -- Baixa Prioridade: Anomalias físicas/orbitais
            WHEN a.albedo > 0.3 AND i.e > 0.8 AND i.i > 70 AND a.diameter > 0.2 THEN 1

            ELSE 1
        END AS priority_level,

        -- Descrição do Alerta
        CASE
            WHEN a.diameter > @Diametro_30m AND i.moid < @Distancia_1LD_UA
                THEN 'CRÍTICO: Aproximação < 1 Distância Lunar'
            WHEN a.diameter > 0.05 AND i.moid_ld < 5
                THEN 'PERIGO: Objeto próximo com órbita precisa'
            WHEN a.pha = 'Y' AND i.rms > 0.8
                THEN 'INCERTEZA: PHA com trajetória instável'
            WHEN a.diameter > @Diametro_500m
                THEN 'MONITORIZAÇÃO: Novo objeto de grande porte'
            ELSE 'ANOMALIA: Parâmetros orbitais atípicos'
        END AS description,
        1  -- is_active = TRUE (ativo por padrão)
    FROM inserted i
    INNER JOIN Asteroid a ON i.asteroid_id = a.asteroid_id
    WHERE
        -- Filtro: Só gera alerta se cumprir uma das condições de risco
        (a.diameter > @Diametro_30m AND i.moid < @Distancia_1LD_UA) OR
        (a.diameter > 0.05 AND i.moid_ld < 5 AND i.rms < 0.3) OR
        (a.pha = 'Y' AND a.diameter > @Diametro_100m AND i.rms > 0.8 AND i.moid_ld < 20) OR
        (a.diameter > @Diametro_500m AND i.moid_ld < 50) OR
        (a.albedo > 0.3 AND i.e > 0.8 AND i.i > 70 AND a.diameter > 0.2);
END
GO

-- TRIGGER 2: MONITORIZAÇÃO DE MUDANÇAS ORBITAIS
-- Compara a nova órbita com a anterior para detetar alterações suspeitas.

CREATE OR ALTER TRIGGER trg_VerificarMudancaOrbital
ON Orbital_Parameters
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO Alert (asteroid_id, alert_date, priority_level, description, is_active)
    SELECT
        i.asteroid_id,
        GETDATE(),
        2, -- Prioridade Média
        CONCAT('Mudança Orbital: ',
               CASE WHEN ABS(i.e - prev.e) > 0.05 THEN 'Excentricidade variou > 0.05. ' ELSE '' END,
               CASE WHEN ABS(i.i - prev.i) > 2 THEN 'Inclinação variou > 2 graus.' ELSE '' END
        ),
        1  -- is_active = TRUE
    FROM inserted i
    CROSS APPLY (
        -- Busca o registo orbital imediatamente anterior do mesmo asteroide
        SELECT TOP 1 *
        FROM Orbital_Parameters op
        WHERE op.asteroid_id = i.asteroid_id
          AND op.orbit_param_id < i.orbit_param_id
        ORDER BY op.orbit_param_id DESC
    ) prev
    WHERE
        -- ativado apenas for superior a estes limites definidos
        ABS(i.e - prev.e) > 0.05 OR ABS(i.i - prev.i) > 2;
END
GO

-- TRIGGER 3: CONSISTÊNCIA DE DADOS (Atualizar PHA e NEO)
-- Garante que a classificação do asteroide reflete a órbita mais recente.

CREATE OR ALTER TRIGGER trg_AtualizarClassificacao_Auto
ON Orbital_Parameters
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    -- Atualiza a tabela Asteroid
    UPDATE a
    SET
        -- Define PHA = 'Y' se MOID <= 0.05 UA e tiver tamanho considerável
        pha = CASE
                WHEN i.moid <= 0.05 AND (a.diameter >= 0.14 OR a.H <= 22.0) THEN 'Y'
                ELSE a.pha -- Mantém o valor atual se não for crítico
              END,
        -- Define NEO = 'Y' se a distância do periélio (q) for < 1.3 UA
        neo = CASE
                WHEN i.q < 1.3 THEN 'Y'
                ELSE a.neo
              END
    FROM Asteroid a
    INNER JOIN inserted i ON a.asteroid_id = i.asteroid_id;
END
GO